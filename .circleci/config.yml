version: 2.1

jobs:
  build:  
    docker:
      - image: cimg/openjdk:11.0
      auth:
        username: mydockerhub-user
        password: $DOCKERHUB_PASSWORD
    steps:
      # Checkout the code as the first step.
      - checkout
      # Use mvn clean and package as the standard maven build phase
      - run: mvn package
      - persist_to_workspace:
        root: ./
        paths:
          - target/
  test:
    docker:
      - image: cimg/openjdk:11.0
    auth:
        username: mydockerhub-user
        password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      -  attach_workspace:
        at: ./target
      # Then run your tests!
      - run: mvn test
  

workflows:
  version: 2.1
  # Below is the definition of your workflow.
  # Inside the workflow, you provide the jobs you want to run, e.g this workflow runs the build-and-test job above.
  # CircleCI will run this workflow on every commit.
  # For more details on extending your workflow, see the configuration docs: https://circleci.com/docs/2.0/configuration-reference/#workflows
  build-then-test: 
    jobs:
      - build
      - test:
        requires:
          - build
